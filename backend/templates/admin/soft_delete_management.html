{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}Soft Delete Management | {{ site_title|default:_('Margav Energy CRM Administration') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
  &rsaquo; {% trans 'Soft Delete Management' %}
</div>
{% endblock %}

{% block content %}
<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    border-left: 4px solid #667eea;
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    color: #333;
  }
  
  .stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
  }
  
  .stat-label {
    color: #666;
    font-size: 0.9rem;
  }
  
  .expired {
    border-left-color: #dc3545;
  }
  
  .expired .stat-number {
    color: #dc3545;
  }
  
  .deleted {
    border-left-color: #ffc107;
  }
  
  .deleted .stat-number {
    color: #ffc107;
  }
  
  .action-buttons {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
  }
  
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }
  
  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    color: white;
    text-decoration: none;
  }
  
  .btn-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff8f00 100%);
    color: white;
  }
  
  .btn-danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
  }
  
  .recent-deletions {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 20px;
  }
  
  .recent-deletions h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #667eea;
    padding-bottom: 10px;
  }
  
  .deletion-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .deletion-item:last-child {
    border-bottom: none;
  }
  
  .deletion-info {
    flex: 1;
  }
  
  .deletion-actions {
    display: flex;
    gap: 5px;
  }
  
  .btn-small {
    padding: 5px 10px;
    font-size: 0.8rem;
  }
</style>

<div class="module aligned">
  <h2>Soft Delete Management</h2>
  <p>Manage soft deleted objects with 30-day retention period</p>
  
  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>Leads</h3>
      <div class="stat-number">{{ total_leads }}</div>
      <div class="stat-label">Total Active</div>
    </div>
    
    <div class="stat-card deleted">
      <h3>Deleted Leads</h3>
      <div class="stat-number">{{ deleted_leads }}</div>
      <div class="stat-label">Soft Deleted</div>
    </div>
    
    <div class="stat-card expired">
      <h3>Expired Leads</h3>
      <div class="stat-number">{{ expired_leads }}</div>
      <div class="stat-label">Ready for Cleanup</div>
    </div>
    
    <div class="stat-card">
      <h3>Callbacks</h3>
      <div class="stat-number">{{ total_callbacks }}</div>
      <div class="stat-label">Total Active</div>
    </div>
    
    <div class="stat-card deleted">
      <h3>Deleted Callbacks</h3>
      <div class="stat-number">{{ deleted_callbacks }}</div>
      <div class="stat-label">Soft Deleted</div>
    </div>
    
    <div class="stat-card expired">
      <h3>Expired Callbacks</h3>
      <div class="stat-number">{{ expired_callbacks }}</div>
      <div class="stat-label">Ready for Cleanup</div>
    </div>
  </div>
  
  <!-- Action Buttons -->
  <div class="action-buttons">
    <a href="{% url 'admin:leads_lead_changelist' %}" class="btn btn-primary">View All Leads</a>
    <a href="{% url 'admin:leads_callback_changelist' %}" class="btn btn-primary">View All Callbacks</a>
    <button onclick="cleanupExpired()" class="btn btn-warning">Cleanup Expired Objects</button>
    <button onclick="showStats()" class="btn btn-primary">Refresh Statistics</button>
  </div>
  
  <!-- Recent Deletions -->
  {% if recent_deleted_leads %}
  <div class="recent-deletions">
    <h3>Recent Lead Deletions</h3>
    {% for lead in recent_deleted_leads %}
    <div class="deletion-item">
      <div class="deletion-info">
        <strong>{{ lead.full_name }}</strong> - {{ lead.phone }}
        <br>
        <small>Deleted: {{ lead.deleted_at|date:"M d, Y H:i" }} by {{ lead.deleted_by|default:"System" }}</small>
        {% if lead.deletion_reason %}
        <br>
        <small>Reason: {{ lead.deletion_reason }}</small>
        {% endif %}
      </div>
      <div class="deletion-actions">
        <a href="{% url 'admin:leads_lead_restore' lead.pk %}" class="btn btn-primary btn-small">Restore</a>
        {% if lead.is_expired %}
        <span style="color: #dc3545; font-size: 0.8rem;">EXPIRED</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  
  {% if recent_deleted_callbacks %}
  <div class="recent-deletions">
    <h3>Recent Callback Deletions</h3>
    {% for callback in recent_deleted_callbacks %}
    <div class="deletion-item">
      <div class="deletion-info">
        <strong>{{ callback.lead.full_name }}</strong> - {{ callback.scheduled_time|date:"M d, Y H:i" }}
        <br>
        <small>Deleted: {{ callback.deleted_at|date:"M d, Y H:i" }} by {{ callback.deleted_by|default:"System" }}</small>
        {% if callback.deletion_reason %}
        <br>
        <small>Reason: {{ callback.deletion_reason }}</small>
        {% endif %}
      </div>
      <div class="deletion-actions">
        <a href="{% url 'admin:leads_callback_restore' callback.pk %}" class="btn btn-primary btn-small">Restore</a>
        {% if callback.is_expired %}
        <span style="color: #dc3545; font-size: 0.8rem;">EXPIRED</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

<script>
function cleanupExpired() {
  if (confirm('This will permanently delete all objects that have been soft deleted for 30+ days. Continue?')) {
    // This would need to be implemented as a proper form submission or AJAX call
    alert('Cleanup functionality would be implemented here');
  }
}

function showStats() {
  location.reload();
}
</script>
{% endblock %}
